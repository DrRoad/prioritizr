<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">



<title>Contributing to prioritizr</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Contributing to <em>prioritizr</em></h1>



<p>The aim of this vignette is to provide a comprehensive guide for making contributions to <em>prioritizr</em>. It also serves to document the internal organization of this package and the rationale behind its design. This vignette is still under construction and will be updated when possible. It is beyond the scope of this vignette to teach <em>R</em> programming or package development practices. We strongly recommend reading the <a href="http://r4ds.had.co.nz/"><em>R for Data Science</em></a>, <a href="http://adv-r.had.co.nz/"><em>Advanced R</em></a>, and <a href="http://r-pkgs.had.co.nz/"><em>R Packages</em></a> books to learn more about these topics. If you have any questions about contributing to <em>prioritizr</em> that are not covered by this vignette, please <a href="https://github.com/prioritizr/prioritizr/issues/new">post an issue on the GitHub repository</a>.</p>
<div id="style-guide" class="section level1">
<h1>Style guide</h1>
<p>This package uses American spelling for all English words. All code should use snake-case (i.e. under-scores and lower-case spelling; e.g. <code>add_relative_targets</code>), except for class names which use camel-case (i.e. no under-scores and upper-case letters; e.g. <code>ConservationProblem</code>). The <code>&lt;-</code> operator should be used for object assignment. Spaces should surround all infix operators (e.g. <code>+</code>, <code>-</code>, etc.) and should be placed after commas. All indenting should use two-spaces. All lines should not exceed 80 characters in length, except for text in vignettes. All code should escape characters using double quotes (i.e. <code>&quot;</code> symbols). Where possible, functions from other packages should not be imported and instead should be referred to using the <code>::</code> function (e.g. <code>Matrix::sparseMatrix</code> to access the <code>sparseMatrix</code> function from the <em>Matrix</em> package). All functions should use the <a href="https://cran.r-project.org/web/packages/assertthat/index.html"><em>assertthat</em> package</a> to validate arguments. All functions should have at least one unit test, and all unit tests should use the <a href="https://cran.r-project.org/web/packages/testthat/index.html"><em>testthat</em> package</a>. All private functions that are not exported from the NAMESPACE should be located in the <em>R/internal.R</em> file. Although this package exports the pipe operator (<code>%&gt;%</code>) for ease of use, for clarity, this operator should not be used elsewhere in this package’s source code (excepting documentation and unit tests).</p>
<p>Documentation should be written using <em>roxygen2</em>. Software and R package names should be written in <em>italics</em> (e.g. ). When referring to parameter names in the documentation, they should be encapsulated by \code tags (e.g.  in help for <em>problem</em>). When referring to the names of columns in a data.frame object, please use the format \code{“column_name”}, where <code>column_name</code> is the name of the column (e.g. \code{“mpg”} to refer to a column in the <code>mtcars</code> object). All help files for functions should contain at least the following sections: Description, Arguments, Value, and Examples.</p>
</div>
<div id="conservation-problems" class="section level1">
<h1>Conservation problems</h1>
<p>The <code>ConservationProblem</code> class (defined in <em>R/ConservationProblem-proto.R</em>) is used to represent conservation planning objects. They are created by the <code>problem</code> function and should contain all the data and parameters needed to generate a mathematical formulation of the problem.</p>
</div>
<div id="conservation-modifiers" class="section level1">
<h1>Conservation modifiers</h1>
<p>The <code>ConservationModifier</code> class (defined in <em>R/ConservationModifier-proto.R</em>) is used to represent any object that alters the behavior of a <code>ConservationProblem</code> object. All of the functions used for specifying objectives, constraints, penalties, decisions, solvers, and portfolios involve creating a new <code>ConservationModifier</code> object and appending it to a <code>ConservationProblem</code> object. To help standardize the behavior of different <code>ConservationModifier</code> objects, we have created specializations of the <code>ConservationModifier</code> class: <code>Objective</code> (defined in <em>R/Objective-proto.R</em>), <code>Constraint</code> (defined in <em>R/Constraint-proto.R</em>), <code>Penalty</code> (defined in <em>R/Penalty-proto.R</em>), <code>Decision</code> (defined in <em>R/Decision-proto.R</em>), <code>Solver</code> (defined in <em>R/Solver-proto.R</em>), and <code>Portfolio</code> (defined in <em>R/Portfolio-proto.R</em>).</p>
</div>
<div id="optimization-problems" class="section level1">
<h1>Optimization problems</h1>
<p>The <code>OptimizationProblem</code> class (defined in <em>R/OptimizationProblem-proto.R</em>) represents the precise mathematical formulation of a conservation planning problem. When a <code>ConservationProblem</code> object is “solved” (using the <code>solve</code> function), the <code>ConservationProblem</code> object is first “compiled” into an <code>OptimizationProblem</code> object (using the <code>compile</code> function) and the <code>OptimizationProblem</code> object is then solved (using the <code>solve</code> function). This distinction is important because if a contributor wants to add a new objective, constraint, penalty, or decision function to <em>prioritizr</em> they will need to write code that adds the mathematical formulation of the function to a <code>OptimizationProblem</code> object. This is not entirely trivial.</p>
<p>All <code>OptimizationProblem</code> objects are simply a wrapper to an external pointer pointer (<code>XPtr</code>) that points to a C++ <code>OPTIMIZATIONPROBLEM</code> class object (defined in <em>src/optimization_problem.h</em>). We decided to implement the <code>OptimizationProblem</code> class in this manner because (1) storing objects as external pointers reduces memory consumption and (2) the process of adding in constraints requires iteration and loops which are slow in <em>R</em>. We elected not to use the <em>ompr R</em> package because (1) benchmarks at the time indicated that this package would take too long to compile problems with many constraints and (2) it uses the R Optimization Infrastructure (ROI) which cannot as yet solve problems using <em>Gurobi</em> (discounting repositories on GitHub that are not actively maintained). As a consequence, <em>Rcpp</em> code is needed to modify <code>OptimizationProblem</code> objects and users will need to write <em>Rcpp</em> functions to add new objectives, constraints, penalties to <em>prioritizr</em>. It is beyond the scope of this vignette to teach <em>Rcpp</em> programming, and so we recommend that potential contributors read the <a href="https://teuder.github.io/rcpp4everyone_en/#"><em>Rcpp for everyone</em></a> book if they are unfamiliar with <em>Rcpp</em> and C++ programming.</p>
<p>The C++ <code>OPTIMIZATIONPROBLEM</code> class contains the standard data needed to formulate a mixed integer linear programming problem (e.g. objective function, model sense, constraint senses, etc.) as well as additional data that pertain to conservation problems (i.e. number of features, planning units, and zones). If a potential contributor is unfamiliar with the standard representation of a mixed integer linear programming problem, we strongly suggest reading the documentation for the <a href="http://www.gurobi.com/documentation/7.5/refman/solving_models_with_the_gu.html"><em>gurobi R</em> package</a>. The fields _A_i, <em>A_j</em>, and <em>A_x</em> correspond the row, column, and cells values for the design matrix of the optimization problem (respectively). The other fields follow standard conventions. Note that the design matrix is, ultimately, constructed as a <code>Matrix::sparseMatrix</code> so row and column indices do not need to be sequential. Additionally, note that all <em>Rcpp</em> constraint and penalty functions should be independent. In other words, though it may be computationally efficient to reuse constraints and variables encoded in other functions, each <em>Rcpp</em> constraint and penalty function define its own constraints and variables. All conservation planning problems are defined following one of two standard mathematical formulations: the compressed and the expanded formulation.</p>
<p>The compressed formulation defines a problem which assumes that all instances of a conserved feature are used to achieve the target or count towards the benefit of a solution. Although the expanded formulation can provide identical solutions to the compressed formulation, the compressed formulation is provided because it is simpler and can be used with much larger sized problems. Currently, all constraints use the compressed formulation except for the <code>add_corridors_constraints</code> function. Under this formulation, the first set of decision variables (the first number of planning units <span class="math inline">\(\times\)</span> number of zones) always pertain to the state of the planning units. Thus in a problem containing 3 planning units and 2 zones, the first six variables indicate the allocation of: planning unit 1 in zone 1, planning unit 2 in zone 1, planning unit 3 in zone 1, planning unit 1 in zone 2, planning unit 2 in zone 2, planning unit 3 in zone 2. The first set of constraints (rows) always correspond to each target (noting that some objectives use “fake” targets to initialize the feature by planning unit (referred to as <em>rij</em>) data, see <em>R/compile.R</em>). These rows, which each correspond to a single target, contain the amount of each feature in each zone for which the target pertains. Thus rows for targets which pertain to a single zone will only contain feature abundance data for planning units (columns) in a single zone, and rows for targets which pertain to a single feature in multiple zones will contain feature abundance data for planning units (columns) in multiple zones.</p>
<p>To help illustrate the compressed formulation, consider the following problem:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># simulate data</span>
pu &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">id =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">cost_1 =</span> <span class="dv">4</span><span class="op">:</span><span class="dv">6</span>, <span class="dt">cost_2 =</span> <span class="dv">7</span><span class="op">:</span><span class="dv">9</span>)
zone &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">id =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dt">name =</span> <span class="kw">c</span>(<span class="st">&quot;z1&quot;</span>, <span class="st">&quot;z2&quot;</span>))
feature &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">id =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dt">name =</span> <span class="kw">c</span>(<span class="st">&quot;f1&quot;</span>, <span class="st">&quot;f2&quot;</span>))
rij &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(<span class="dt">pu =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">species =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dt">zone =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)
rij<span class="op">$</span>amount &lt;-<span class="st"> </span><span class="kw">seq_len</span>(<span class="kw">nrow</span>(rij)) <span class="op">+</span><span class="st"> </span><span class="kw">nrow</span>(rij)
targets &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">1</span>, <span class="dt">nrow =</span> <span class="dv">2</span>, <span class="dt">ncol =</span> <span class="dv">2</span>)

<span class="co"># create problem</span>
p &lt;-<span class="st"> </span><span class="kw">problem</span>(pu, feature, rij, <span class="kw">c</span>(<span class="st">&quot;cost_1&quot;</span>, <span class="st">&quot;cost_2&quot;</span>), zone) <span class="op">%&gt;%</span>
<span class="st">     </span><span class="kw">add_absolute_targets</span>(targets)

<span class="co"># print problem</span>
<span class="kw">print</span>(p)</code></pre></div>
<pre><code>## Conservation Problem
##   zones:          z1, z2 (2 zones)
##   planning units: data.frame (3 units)
##   cost:           min: 4, max: 9
##   features:       f1, f2 (2 features)
##   objective:      none
##   targets:        Absolute targets [targets (min: 1, max: 1)]
##   decisions:      default
##   constraints:    &lt;none&gt;
##   penalties:      &lt;none&gt;
##   portfolio:      default
##   solver:         default</code></pre>
<p>The compressed formulation expresses the planning unit and feature data using the following design matrix. Here, each variable (column) corresponds to a different planning unit and a different zone allocation, each constraint (row) corresponds to a different target, and each cell corresponds to the amount of a each feature in each planning unit given a different zone (based on the targets).</p>
<pre><code>## 4 x 6 sparse Matrix of class &quot;dgCMatrix&quot;
##              pu1_z1 pu2_z1 pu3_z1 pu1_z2 pu2_z2 pu3_z2
## target_f1_z1     13     14     15      .      .      .
## target_f2_z1     16     17     18      .      .      .
## target_f1_z2      .      .      .     19     20     21
## target_f2_z2      .      .      .     22     23     24</code></pre>
<p>The expanded formulation, on the other hand, defines a problem which can allow for some instances of conserved features to not be used for achieving the targets or maximizing the conservation benefit. This formulation is a generalized version of the compressed formulation. It contains additional variables (columns) and constraints (rows) for each combination of feature, planning unit, and zone that indicate if a given planning unit allocated to a specific zone is also allocated to conserve a given feature.</p>
<p>Given the previous problem, the expanded formulation expresses the planning unit and feature data in the design matrix as:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># generate targets</span>
targets2 &lt;-<span class="st"> </span>p<span class="op">$</span>targets<span class="op">$</span><span class="kw">output</span>()

<span class="co"># create matrix</span>
m &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="ot">NA</span>, <span class="dt">ncol =</span> (p<span class="op">$</span><span class="kw">number_of_zones</span>() <span class="op">*</span><span class="st"> </span>p<span class="op">$</span><span class="kw">number_of_planning_units</span>()) <span class="op">+</span>
<span class="st">                       </span>(p<span class="op">$</span><span class="kw">number_of_zones</span>() <span class="op">*</span><span class="st"> </span>p<span class="op">$</span><span class="kw">number_of_planning_units</span>() <span class="op">*</span>
<span class="st">                        </span>p<span class="op">$</span><span class="kw">number_of_features</span>()),
            <span class="dt">nrow =</span> (p<span class="op">$</span><span class="kw">number_of_zones</span>() <span class="op">*</span><span class="st"> </span>p<span class="op">$</span><span class="kw">number_of_planning_units</span>() <span class="op">*</span>
<span class="st">                    </span>p<span class="op">$</span><span class="kw">number_of_features</span>()) <span class="op">+</span>
<span class="st">                    </span>(p<span class="op">$</span><span class="kw">number_of_features</span>() <span class="op">*</span><span class="st"> </span>p<span class="op">$</span><span class="kw">number_of_zones</span>()))

<span class="co"># add row names</span>
<span class="kw">rownames</span>(m) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">paste0</span>(<span class="st">&quot;pu&quot;</span>, <span class="kw">rep</span>(<span class="kw">seq_len</span>(p<span class="op">$</span><span class="kw">number_of_planning_units</span>()),
                                            p<span class="op">$</span><span class="kw">number_of_zones</span>() <span class="op">*</span>
<span class="st">                                            </span>p<span class="op">$</span><span class="kw">number_of_features</span>()),
                          <span class="st">&quot;_&quot;</span>, <span class="kw">rep</span>(<span class="kw">rep</span>(p<span class="op">$</span><span class="kw">feature_names</span>(),
                                       <span class="dt">each =</span> p<span class="op">$</span><span class="kw">number_of_planning_units</span>()),
                                   p<span class="op">$</span><span class="kw">number_of_zones</span>()),
                          <span class="st">&quot;_&quot;</span>, <span class="kw">rep</span>(p<span class="op">$</span><span class="kw">zone_names</span>(),
                                   <span class="dt">each =</span> p<span class="op">$</span><span class="kw">number_of_planning_units</span>() <span class="op">*</span>
<span class="st">                                          </span>p<span class="op">$</span><span class="kw">number_of_features</span>())),
                 <span class="kw">paste0</span>(<span class="st">&quot;target_&quot;</span>, <span class="kw">rep</span>(p<span class="op">$</span><span class="kw">feature_names</span>(), p<span class="op">$</span><span class="kw">number_of_zones</span>()),
                        <span class="st">&quot;_&quot;</span>, <span class="kw">rep</span>(p<span class="op">$</span><span class="kw">zone_names</span>(),
                                 <span class="dt">each =</span> p<span class="op">$</span><span class="kw">number_of_features</span>())))

<span class="co"># add column names</span>
<span class="kw">colnames</span>(m) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">paste0</span>(<span class="st">&quot;pu&quot;</span>, <span class="kw">rep</span>(<span class="kw">seq_len</span>(p<span class="op">$</span><span class="kw">number_of_planning_units</span>()),
                                          p<span class="op">$</span><span class="kw">number_of_zones</span>()),
                        <span class="st">&quot;_&quot;</span>, <span class="kw">rep</span>(p<span class="op">$</span><span class="kw">zone_names</span>(),
                                 <span class="dt">each =</span> p<span class="op">$</span><span class="kw">number_of_planning_units</span>())),
                 <span class="kw">paste0</span>(<span class="st">&quot;pu&quot;</span>, <span class="kw">rep</span>(<span class="kw">seq_len</span>(p<span class="op">$</span><span class="kw">number_of_planning_units</span>()),
                                          p<span class="op">$</span><span class="kw">number_of_zones</span>() <span class="op">*</span>
<span class="st">                                          </span>p<span class="op">$</span><span class="kw">number_of_features</span>()),
                        <span class="st">&quot;_&quot;</span>, <span class="kw">rep</span>(<span class="kw">rep</span>(p<span class="op">$</span><span class="kw">feature_names</span>(),
                                     <span class="dt">each =</span> p<span class="op">$</span><span class="kw">number_of_planning_units</span>()),
                                 p<span class="op">$</span><span class="kw">number_of_zones</span>()),
                        <span class="st">&quot;_&quot;</span>, <span class="kw">rep</span>(p<span class="op">$</span><span class="kw">zone_names</span>(),
                                 <span class="dt">each =</span> p<span class="op">$</span><span class="kw">number_of_planning_units</span>() <span class="op">*</span>
<span class="st">                                        </span>p<span class="op">$</span><span class="kw">number_of_features</span>())))

<span class="co"># add in indicator variables and constraints</span>
curr_row &lt;-<span class="st"> </span><span class="dv">0</span>
<span class="cf">for</span> (z <span class="cf">in</span> <span class="kw">seq_len</span>(p<span class="op">$</span><span class="kw">number_of_zones</span>())) {
  <span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_len</span>(p<span class="op">$</span><span class="kw">number_of_features</span>())) {
    <span class="cf">for</span> (j <span class="cf">in</span> <span class="kw">seq_len</span>(p<span class="op">$</span><span class="kw">number_of_planning_units</span>())) {
      curr_row &lt;-<span class="st"> </span>curr_row <span class="op">+</span><span class="st"> </span><span class="dv">1</span>
      curr_col1 &lt;-<span class="st"> </span>((z <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span>p<span class="op">$</span><span class="kw">number_of_planning_units</span>()) <span class="op">+</span><span class="st"> </span>j
      curr_col2 &lt;-<span class="st"> </span>(p<span class="op">$</span><span class="kw">number_of_planning_units</span>() <span class="op">*</span><span class="st"> </span>p<span class="op">$</span><span class="kw">number_of_zones</span>()) <span class="op">+</span>
<span class="st">                   </span>((z <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span>p<span class="op">$</span><span class="kw">number_of_features</span>() <span class="op">*</span>
<span class="st">                              </span>p<span class="op">$</span><span class="kw">number_of_planning_units</span>()) <span class="op">+</span>
<span class="st">                   </span>((i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span>p<span class="op">$</span><span class="kw">number_of_planning_units</span>()) <span class="op">+</span><span class="st"> </span>j
      m[curr_row, curr_col1] &lt;-<span class="st"> </span><span class="op">-</span><span class="dv">1</span>
      m[curr_row, curr_col2] &lt;-<span class="st"> </span><span class="dv">1</span>
    }
  }
}

<span class="co"># add in targets</span>
<span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_len</span>(<span class="kw">nrow</span>(targets2))) {
  <span class="co"># extract indices</span>
  curr_row &lt;-<span class="st"> </span>curr_row <span class="op">+</span><span class="st"> </span><span class="dv">1</span>
  curr_feature &lt;-<span class="st"> </span>targets2<span class="op">$</span>feature[i]
  curr_zone &lt;-<span class="st"> </span>targets2<span class="op">$</span>zone[i][[<span class="dv">1</span>]]
  curr_cols &lt;-<span class="st"> </span>(p<span class="op">$</span><span class="kw">number_of_planning_units</span>() <span class="op">*</span><span class="st"> </span>p<span class="op">$</span><span class="kw">number_of_zones</span>()) <span class="op">+</span>
<span class="st">               </span>((curr_zone <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span>p<span class="op">$</span><span class="kw">number_of_features</span>() <span class="op">*</span>
<span class="st">                                 </span>p<span class="op">$</span><span class="kw">number_of_planning_units</span>()) <span class="op">+</span>
<span class="st">               </span>((curr_feature <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">*</span><span class="st"> </span>p<span class="op">$</span><span class="kw">number_of_planning_units</span>()) <span class="op">+</span>
<span class="st">               </span><span class="kw">seq_len</span>(p<span class="op">$</span><span class="kw">number_of_planning_units</span>())
  curr_amount &lt;-<span class="st"> </span>rij<span class="op">$</span>amount[<span class="kw">unlist</span>(rij<span class="op">$</span>zone) <span class="op">==</span><span class="st"> </span>curr_zone <span class="op">&amp;</span>
<span class="st">                            </span>rij<span class="op">$</span>species <span class="op">==</span><span class="st"> </span>curr_feature]
  <span class="co"># set matrix values</span>
  m[curr_row, curr_cols] &lt;-<span class="st"> </span>curr_amount
}

<span class="co"># convert to sparse matrix</span>
m[<span class="kw">is.na</span>(m)] &lt;-<span class="st"> </span><span class="dv">0</span>
m &lt;-<span class="st"> </span><span class="kw">as</span>(m, <span class="st">&quot;sparseMatrix&quot;</span>)

<span class="co"># print matrix</span>
<span class="kw">print</span>(m)</code></pre></div>
<pre><code>## 16 x 18 sparse Matrix of class &quot;dgCMatrix&quot;</code></pre>
<pre><code>##    [[ suppressing 18 column names 'pu1_z1', 'pu2_z1', 'pu3_z1' ... ]]</code></pre>
<pre><code>##                                                                   
## pu1_f1_z1    -1  .  .  .  .  .  1  .  .  .  .  .  .  .  .  .  .  .
## pu2_f1_z1     . -1  .  .  .  .  .  1  .  .  .  .  .  .  .  .  .  .
## pu3_f1_z1     .  . -1  .  .  .  .  .  1  .  .  .  .  .  .  .  .  .
## pu1_f2_z1    -1  .  .  .  .  .  .  .  .  1  .  .  .  .  .  .  .  .
## pu2_f2_z1     . -1  .  .  .  .  .  .  .  .  1  .  .  .  .  .  .  .
## pu3_f2_z1     .  . -1  .  .  .  .  .  .  .  .  1  .  .  .  .  .  .
## pu1_f1_z2     .  .  . -1  .  .  .  .  .  .  .  .  1  .  .  .  .  .
## pu2_f1_z2     .  .  .  . -1  .  .  .  .  .  .  .  .  1  .  .  .  .
## pu3_f1_z2     .  .  .  .  . -1  .  .  .  .  .  .  .  .  1  .  .  .
## pu1_f2_z2     .  .  . -1  .  .  .  .  .  .  .  .  .  .  .  1  .  .
## pu2_f2_z2     .  .  .  . -1  .  .  .  .  .  .  .  .  .  .  .  1  .
## pu3_f2_z2     .  .  .  .  . -1  .  .  .  .  .  .  .  .  .  .  .  1
## target_f1_z1  .  .  .  .  .  . 13 14 15  .  .  .  .  .  .  .  .  .
## target_f2_z1  .  .  .  .  .  .  .  .  . 16 17 18  .  .  .  .  .  .
## target_f1_z2  .  .  .  .  .  .  .  .  .  .  .  . 19 20 21  .  .  .
## target_f2_z2  .  .  .  .  .  .  .  .  .  .  .  .  .  .  . 22 23 24</code></pre>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
